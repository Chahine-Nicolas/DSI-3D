#+STARTUP: indent

* these_place_reco_main
 
** run jean-zay

## DÃ©marer pdb et lancer le job dans minibuffer
- M-X pdb 
- bash
- JOB_ID=$(squeue -lu $USER | grep $USER | sed 's@^[^0-9]*\([0-9]\+\).*@\1@') && echo "job id : $JOB_ID"
- srun --pty --jobid $JOB_ID  --nodes=1 --ntasks-per-node=1 --cpus-per-task=10 --gres=gpu:1 --hint=nomultithread  --time=24:00:00 bash
- conda activate sandbox
- source run.sh 


** old notes etc...
### v100
## salloc --nodes=1 --ntasks-per-node=1 --account xhk@v100 --job-name PlaceReco --ntasks 1 --partition gpu_p13 --constraint v100-32g --time=4:00:00 --gres gpu:1 --cpus-per-task 40 --hint nomultithread --mail-user laurent.caraffa@ign.fr
### P4
## salloc --nodes=1 --ntasks-per-node=1 --account xhk@v100 --job-name PlaceReco --ntasks 1 --partition gpu_p4 --time=4:00:00 --gres gpu:1 --cpus-per-task 40 --hint nomultithread --mail-user laurent.caraffa@ign.fr

## BLIP
python -m pdb main_v3.py --launcher none --cfg_file ./config.yaml --workers 1 --extra_tag DSI --pretrained_model /gpfswork/rech/xhk/$USER/datas/OpenPCDet/ckpts/gd_mae_pretrain_kitti.pth --max_ckpt_save_num 10 --num_epochs_to_eval 1 --per_device_train_batch_size 16 --per_device_eval_batch_size 16 --save_to_file --remove_unused_columns False --dataloader_pin_memory False --output_dir /gpfswork/rech/xhk/$USER/datas/transformers/dsi-lidar/ --adam_epsilon=1e-04 --adam_beta1=0.95 --adam_beta2=0.99 --num_train_epochs 1000 --learning_rate=1e-03 --eval_steps 20 --evaluation_strategy steps --logging_steps 1

## GIT
python -m pdb main_v3.py --launcher none --cfg_file ./config.yaml --workers 1 --extra_tag DSI --pretrained_model /gpfswork/rech/xhk/$USER/datas/OpenPCDet/ckpts/gd_mae_pretrain_kitti.pth --max_ckpt_save_num 10 --num_epochs_to_eval 1 --per_device_train_batch_size 16 --per_device_eval_batch_size 2 --save_to_file --remove_unused_columns False --dataloader_pin_memory False --output_dir /gpfswork/rech/xhk/$USER/datas/transformers/dsi-lidar/ --adam_epsilon=1e-05 --adam_beta1=0.90 --adam_beta2=0.99 --num_train_epochs 1000 --learning_rate=1e-05 --eval_steps 20 --evaluation_strategy steps --logging_steps 5

interact



JOB_ID=$(squeue -lu $USER | grep $USER | sed 's@^[^0-9]*\([0-9]\+\).*@\1@') && echo "job id : $JOB_ID"
srun --pty --jobid $JOB_ID  --nodes=1 --ntasks-per-node=2 --cpus-per-task=20 --gres=gpu:2 --hint=nomultithread  --time=24:00:00 bash
conda activate sandbox
python main_v3.py --launcher none --model_name blip2 --cfg_file ./config.yaml --workers 1 --extra_tag DSI --pretrained_model /gpfswork/rech/xhk/$USER/datas/OpenPCDet/ckpts/gd_mae_pretrain_kitti.pth --max_ckpt_save_num 10 --num_epochs_to_eval 1 --per_device_train_batch_size 16 --per_device_eval_batch_size 2 --save_to_file --remove_unused_columns False --dataloader_pin_memory False --output_dir /gpfswork/rech/xhk/$USER/datas/transformers/dsi-lidar/  --adam_epsilon=1e-08 --adam_beta1=0.90 --adam_beta2=0.99 --num_train_epochs 20000 --learning_rate=1e-05 --eval_steps 20 --evaluation_strategy steps --logging_steps 1

-> return Blip2ForConditionalGenerationModelOutput(
(Pdb) print(lm_output.logits.dtype)
print(lm_output.logits.dtype)
torch.float16
(Pdb) print(lm_output.logits.shape)
print(lm_output.logits.shape)
torch.Size([2, 11, 30522])


** notes
ln -s /gpfswork/rech/dki/ujo91el/code/GD-MAE/tools/ckpt ckpt
ln -s /gpfswork/rech/dki/ujo91el/datas datas

*** Pixels

pixel_values.shape
torch.Size([16, 3, 224, 224])

Conv2d(3, 1408, kernel_size=(14, 14), stride=(14, 14))

patch_embeds.shape
torch.Size([16, 1408, 16, 16])




patch_embeds.flatten(2).transpose(1, 2)

patch_embeds.shape
torch.Size([16, 256, 1408])
*** lidar


spatial_features.shape
torch.Size([16, 128, 248, 216])

xx.shape
torch.Size([16, 1408, 17, 15])

xx = xx.flatten(2).transpose(1, 2)



int((self.config.vision_config.image_size / self.config.vision_config.patch_size) ** 2 + 1) = 197



* logg3dnet
module load pytorch-gpu/py3/1.10.1
* res
** label
10/14 15:39:46 id:4540 n_id:001557 is_rev:1.0 [loc_ok_1:0 p_dist_1:  3.97 p_dist_mean:  0.00,  loc_ok_10:1 p_dist_10:  2.14
10/14 15:39:46 num_revisits: 787
10/14 15:39:46 num_correct_loc: 947
10/14 15:39:46 percentage_correct_loc: 120.33036848792884
10/14 15:39:46 min_min_dist: 3.74913215637207e-05 max_min_dist: 0.5278027951717377
10/14 15:39:46 F1_TN: 2960.0 F1_FP: 553.0 F1_TP: 209.0 F1_FN: 379.0
10/14 15:39:46 F1_thresh_id: 131
10/14 15:39:46 F1max: 0.3096296296296296


10/14 18:22:07 id:4540 n_id:0 is_rev:1.0 [loc_ok_1:0 p_dist_1:208.63 p_dist_mean:257.84,  loc_ok_10:0 p_dist_10:208.63
10/14 18:22:07 num_revisits: 787
10/14 18:22:07 num_correct_loc: 463
10/14 18:22:07 percentage_correct_loc: 58.83100381194409
10/14 18:22:07 min_min_dist: 5.5909156799316406e-05 max_min_dist: 0.3518669605255127
10/14 18:22:07 F1_TN: 2948.0 F1_FP: 512.0 F1_TP: 255.0 F1_FN: 360.0
10/14 18:22:07 F1_thresh_id: 71
10/14 18:22:07 F1max: 0.3690303907380609






10/15 15:27:32 F1max: 0.3096296296296296
========== MAX BEAMS : 1 ===============
num_revisits: 787
num_correct_loc: 327
percentage_correct_loc: 41.550190597204576
min_min_dist: 3.74913215637207e-05 max_min_dist: 0.5278033316135406
F1_TN: 3396.0 F1_FP: 75.0 F1_TP: 319.0 F1_FN: 295.0
F1_thresh_id: 175
F1max: 0.6329365079365079
========== MAX BEAMS : 2 ===============
num_revisits: 787
num_correct_loc: 327
percentage_correct_loc: 41.550190597204576
min_min_dist: 3.74913215637207e-05 max_min_dist: 0.5278033316135406
F1_TN: 3394.0 F1_FP: 74.0 F1_TP: 416.0 F1_FN: 231.0
F1_thresh_id: 164
F1max: 0.731750219876869
========== MAX BEAMS : 3 ===============
num_revisits: 787
num_correct_loc: 327
percentage_correct_loc: 41.550190597204576
min_min_dist: 3.74913215637207e-05 max_min_dist: 0.5278033316135406
F1_TN: 3364.0 F1_FP: 103.0 F1_TP: 474.0 F1_FN: 181.0
F1_thresh_id: 164
F1max: 0.7694805194805194
========== MAX BEAMS : 4 ===============
num_revisits: 787
num_correct_loc: 327
percentage_correct_loc: 41.550190597204576
min_min_dist: 3.74913215637207e-05 max_min_dist: 0.5278033316135406
F1_TN: 3424.0 F1_FP: 49.0 F1_TP: 502.0 F1_FN: 203.0
F1_thresh_id: 129
F1max: 0.7993630573248408
========== MAX BEAMS : 5 ===============
num_revisits: 787
num_correct_loc: 327
percentage_correct_loc: 41.550190597204576
min_min_dist: 3.74913215637207e-05 max_min_dist: 0.5278033316135406
F1_TN: 3451.0 F1_FP: 25.0 F1_TP: 512.0 F1_FN: 212.0
F1_thresh_id: 116
F1max: 0.8120539254559872
========== MAX BEAMS : 6 ===============
num_revisits: 787
num_correct_loc: 327
percentage_correct_loc: 41.550190597204576
min_min_dist: 3.74913215637207e-05 max_min_dist: 0.5278033316135406
F1_TN: 3398.0 F1_FP: 73.0 F1_TP: 542.0 F1_FN: 154.0
F1_thresh_id: 136
F1max: 0.8268497330282227
========== MAX BEAMS : 7 ===============
num_revisits: 787
num_correct_loc: 327
percentage_correct_loc: 41.550190597204576
min_min_dist: 3.74913215637207e-05 max_min_dist: 0.5278033316135406
F1_TN: 3442.0 F1_FP: 35.0 F1_TP: 557.0 F1_FN: 167.0
F1_thresh_id: 116
F1max: 0.8465045592705168
========== MAX BEAMS : 8 ===============
num_revisits: 787
num_correct_loc: 327
percentage_correct_loc: 41.550190597204576
min_min_dist: 3.74913215637207e-05 max_min_dist: 0.5278033316135406
F1_TN: 3439.0 F1_FP: 38.0 F1_TP: 576.0 F1_FN: 151.0
F1_thresh_id: 116
F1max: 0.859060402684564
========== MAX BEAMS : 9 ===============
num_revisits: 787
num_correct_loc: 327
percentage_correct_loc: 41.550190597204576
min_min_dist: 3.74913215637207e-05 max_min_dist: 0.5278033316135406
F1_TN: 3434.0 F1_FP: 45.0 F1_TP: 586.0 F1_FN: 137.0
F1_thresh_id: 116
F1max: 0.8655834564254062
========== MAX BEAMS : 10 ===============
num_revisits: 787
num_correct_loc: 327
percentage_correct_loc: 41.550190597204576
min_min_dist: 3.74913215637207e-05 max_min_dist: 0.5278033316135406
F1_TN: 3440.0 F1_FP: 39.0 F1_TP: 600.0 F1_FN: 132.0
F1_thresh_id: 114
F1max: 0.87527352297593
========== MAX BEAMS : 11 ===============
num_revisits: 787
num_correct_loc: 327
percentage_correct_loc: 41.550190597204576
min_min_dist: 3.74913215637207e-05 max_min_dist: 0.5278033316135406
F1_TN: 3449.0 F1_FP: 30.0 F1_TP: 611.0 F1_FN: 127.0
F1_thresh_id: 110
F1max: 0.8861493836113127
========== MAX BEAMS : 12 ===============
num_revisits: 787
num_correct_loc: 327
percentage_correct_loc: 41.550190597204576
min_min_dist: 3.74913215637207e-05 max_min_dist: 0.5278033316135406
F1_TN: 3447.0 F1_FP: 32.0 F1_TP: 622.0 F1_FN: 119.0
F1_thresh_id: 110
F1max: 0.8917562724014337
========== MAX BEAMS : 13 ===============
num_revisits: 787
num_correct_loc: 327
percentage_correct_loc: 41.550190597204576
min_min_dist: 3.74913215637207e-05 max_min_dist: 0.5278033316135406
F1_TN: 3445.0 F1_FP: 34.0 F1_TP: 628.0 F1_FN: 112.0
F1_thresh_id: 110
F1max: 0.8958630527817403
========== MAX BEAMS : 14 ===============
num_revisits: 787
num_correct_loc: 327
percentage_correct_loc: 41.550190597204576
min_min_dist: 3.74913215637207e-05 max_min_dist: 0.5278033316135406
F1_TN: 3442.0 F1_FP: 37.0 F1_TP: 638.0 F1_FN: 106.0
F1_thresh_id: 110
F1max: 0.8992248062015504
========== MAX BEAMS : 15 ===============
num_revisits: 787
num_correct_loc: 327
percentage_correct_loc: 41.550190597204576
min_min_dist: 3.74913215637207e-05 max_min_dist: 0.5278033316135406
F1_TN: 3436.0 F1_FP: 43.0 F1_TP: 646.0 F1_FN: 99.0
F1_thresh_id: 110
F1max: 0.900976290097629
========== MAX BEAMS : 16 ===============
num_revisits: 787
num_correct_loc: 327
percentage_correct_loc: 41.550190597204576
min_min_dist: 3.74913215637207e-05 max_min_dist: 0.5278033316135406
F1_TN: 3442.0 F1_FP: 36.0 F1_TP: 645.0 F1_FN: 104.0
F1_thresh_id: 104
F1max: 0.9020979020979021
========== MAX BEAMS : 17 ===============
num_revisits: 787
num_correct_loc: 327
percentage_correct_loc: 41.550190597204576
min_min_dist: 3.74913215637207e-05 max_min_dist: 0.5278033316135406
F1_TN: 3431.0 F1_FP: 46.0 F1_TP: 657.0 F1_FN: 91.0
F1_thresh_id: 110
F1max: 0.9055823569951756
========== MAX BEAMS : 18 ===============
num_revisits: 787
num_correct_loc: 327
percentage_correct_loc: 41.550190597204576
min_min_dist: 3.74913215637207e-05 max_min_dist: 0.5278033316135406
F1_TN: 3430.0 F1_FP: 47.0 F1_TP: 662.0 F1_FN: 86.0
F1_thresh_id: 110
F1max: 0.9087165408373369
========== MAX BEAMS : 19 ===============
num_revisits: 787
num_correct_loc: 327
percentage_correct_loc: 41.550190597204576
min_min_dist: 3.74913215637207e-05 max_min_dist: 0.5278033316135406
F1_TN: 3440.0 F1_FP: 37.0 F1_TP: 661.0 F1_FN: 92.0
F1_thresh_id: 104
F1max: 0.9110957960027567
========== MAX BEAMS : 20 ===============
num_revisits: 787
num_correct_loc: 327
percentage_correct_loc: 41.550190597204576
min_min_dist: 3.74913215637207e-05 max_min_dist: 0.5278033316135406
F1_TN: 3440.0 F1_FP: 37.0 F1_TP: 664.0 F1_FN: 89.0
F1_thresh_id: 104
F1max: 0.9133425034387896
10/15 15:27:37 Average times 
